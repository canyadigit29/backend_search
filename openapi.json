{
  "openapi": "3.1.0",
  "info": {
    "title": "Search Documents Assistant API",
    "version": "1.0.0",
    "description": "Search endpoint for Custom GPT."
  },
  "servers": [
    {
      "url": "https://backendsearch-production.up.railway.app",
      "description": "Railway production"
    }
  ],
  "paths": {
    "{
  "openapi": "3.0.0",
  "info": {
    "title": "Scottdale Inc. Search API",
    "version": "1.0.0",
    "description": "API for performing advanced Retrieval-Augmented Generation (RAG) searches across a document corpus."
  },
  "paths": {
    "/api/search/rag-search": {
      "post": {
        "summary": "Perform a RAG Search",
        "description": "This is the consolidated RAG endpoint. It takes a user query, orchestrates the full RAG pipeline based on assistant instructions, and returns a synthesized response. It automatically handles query classification, hybrid search, reranking, and summarization.",
        "operationId": "rag_search_api_search_rag_search_post",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RagSearchRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RagSearchResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad Request",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "detail": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Internal Server Error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "detail": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "RagSearchRequest": {
        "title": "RagSearchRequest",
        "required": [
          "query"
        ],
        "type": "object",
        "properties": {
          "query": {
            "title": "Query",
            "type": "string",
            "description": "The user's search query."
          },
          "response_mode": {
            "title": "Response Mode",
            "type": "string",
            "description": "Response mode: 'summary' or 'structured_results'.",
            "default": "summary"
          },
          "file_name_filter": {
            "title": "File Name Filter",
            "type": "string",
            "description": "Filter results by a specific file name."
          },
          "document_type": {
            "title": "Document Type",
            "type": "string",
            "description": "Filter by document type (e.g., 'ordinance', 'minutes')."
          }
        },
        "description": "The request model for the RAG search endpoint."
      },
      "RagSearchResponse": {
        "title": "RagSearchResponse",
        "required": [
          "summary",
          "summary_was_partial",
          "sources",
          "can_resume",
          "pending_chunk_ids",
          "included_chunk_ids"
        ],
        "type": "object",
        "properties": {
          "summary": {
            "title": "Summary",
            "type": "string",
            "description": "The generated summary of the search results."
          },
          "summary_was_partial": {
            "title": "Summary Was Partial",
            "type": "boolean"
          },
          "sources": {
            "title": "Sources",
            "type": "array",
            "items": {
              "type": "object"
            },
            "description": "A list of source documents for the summary."
          },
          "can_resume": {
            "title": "Can Resume",
            "type": "boolean",
            "description": "Indicates if there are more results to process."
          },
          "pending_chunk_ids": {
            "title": "Pending Chunk Ids",
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "included_chunk_ids": {
            "title": "Included Chunk Ids",
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "retrieved_chunks": {
            "title": "Retrieved Chunks",
            "type": "array",
            "items": {
              "type": "object"
            },
            "description": "Full data for retrieved chunks, only included if response_mode is 'structured_results'."
          }
        }
      }
    }
  }
}
": {
      "post": {
        "operationId": "searchDocumentsAssistant",
        "summary": "Search documents via assistant",
        "description": "Performs a semantic search and returns a summary plus sources. Uses fixed batching: summarizes a diversified set of 25 from the top-50 (capped per file to improve breadth) and returns the remaining top-50 as pending via resume_chunk_ids.",
        "x-oai-meta": {
          "name": "searchDocumentsAssistant",
          "isUserFacing": true
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SearchRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Search results",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SearchResponse"
                }
              }
            }
          }
        }
      }
    },
    "/api/gdrive/sync": {
      "post": {
        "operationId": "triggerGoogleDriveSync",
        "summary": "Sync, OCR, and Ingest New Files from Google Drive",
        "description": "Triggers a background job to sync new files from Google Drive. The process includes downloading, performing OCR on documents, and embedding their content to make them available for search. This command starts the full ingestion pipeline.",
        "x-oai-meta": {
          "name": "triggerGoogleDriveSync",
          "isUserFacing": true
        },
        "responses": {
          "202": {
            "description": "Sync and ingestion process started",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string",
                      "example": "The Google Drive sync and ingestion process has been started in the background. New files will be available for search shortly."
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "SearchRequest": {
        "type": "object",
        "required": [
          "query"
        ],
        "properties": {
          "query": {
            "type": "string"
          },
          "relevance_threshold": {
            "type": "number",
            "description": "Minimum similarity score for a result to be considered relevant (0.0 to 1.0). Default is 0.4.",
            "default": 0.4
          },
          "max_results": {
            "type": "integer",
            "description": "The maximum number of chunks to process for the summary. Default is 100.",
            "default": 100
          },
          "search_weights": {
            "type": "object",
            "description": "Weights to blend semantic and keyword search scores. Both must be provided and sum to 1.0. If omitted, backend defaults to a 50/50 blend.",
            "properties": {
              "semantic": {
                "type": "number",
                "description": "Weight for semantic search (e.g., 0.8 for broad queries)."
              },
              "keyword": {
                "type": "number",
                "description": "Weight for keyword search (e.g., 0.8 for exact-match queries)."
              }
            }
          },
          "or_terms": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Optional alternate phrasings or synonyms. Results from each term are merged by chunk id using the best (max) score before ranking."
          },
          "resume_chunk_ids": {
            "type": "array",
            "description": "Resume mode: specify chunk IDs returned as pending_chunk_ids from a previous response to continue summarization.",
            "items": {
              "type": "string",
              "format": "uuid"
            }
          },
          "response_mode": {
            "type": "string",
            "description": "Controls the output format. 'summary' returns a generated summary. 'structured_results' returns the raw, un-summarized document chunks for client-side processing (e.g., for comparisons or timelines).",
            "enum": [
              "summary",
              "structured_results"
            ],
            "default": "summary"
          }
        }
      },
      "Source": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "file_name": {
            "type": "string"
          },
          "page_number": {
            "type": "integer"
          },
          "score": {
            "type": "number"
          },
          "excerpt": {
            "type": "string"
          },
          "url": {
            "type": "string",
            "format": "uri",
            "description": "A temporary, signed URL to download the source file."
          }
        }
      },
      "RetrievedChunk": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "file_id": {
            "type": "string"
          },
          "file_name": {
            "type": "string"
          },
          "page_number": {
            "type": "integer"
          },
          "chunk_index": {
            "type": "integer"
          },
          "content": {
            "type": "string"
          },
          "score": {
            "type": "number"
          },
          "combined_score": {
            "type": "number"
          },
          "rerank_score": {
            "type": "number"
          }
        }
      },
      "SearchResponse": {
        "type": "object",
        "properties": {
          "summary": {
            "type": [
              "string",
              "null"
            ]
          },
          "summary_was_partial": {
            "type": "boolean",
            "description": "True if the model returned a partial response (rare). Timing is not used for batching."
          },
          "sources": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Source"
            }
          },
          "can_resume": {
            "type": "boolean",
            "description": "True when there are remaining top-50 chunks not yet summarized (fixed 25/25 batching)."
          },
          "pending_chunk_ids": {
            "type": "array",
            "description": "The remaining chunk IDs from the top-50 that were not included in this summary pass (typically the other 25). Send these back via resume_chunk_ids to continue.",
            "items": {
              "type": "string",
              "format": "uuid"
            }
          },
          "included_chunk_ids": {
            "type": "array",
            "description": "Chunk IDs that were included in this summary pass.",
            "items": {
              "type": "string",
              "format": "uuid"
            }
          },
          "retrieved_chunks": {
            "type": "array",
            "description": "The full, un-summarized chunk data. Only returned when response_mode is 'structured_results'.",
            "items": {
              "$ref": "#/components/schemas/RetrievedChunk"
            }
          },
          "error": {
            "type": "string"
          }
        }
      }
    }
  }
}